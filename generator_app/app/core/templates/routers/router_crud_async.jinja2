"""CRUD routes for {{ model.name }} (async)."""

from typing import List
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
{%- if model.pk_type == "UUID" %}
from uuid import UUID
{%- endif %}

from app.db.session import get_db
from app.models.{{ model.module_name }} import {{ model.name }}
from app.schemas.{{ model.module_name }} import (
    {{ model.name }}Create,
    {{ model.name }}Update,
    {{ model.name }}Read,
)

router = APIRouter()


@router.post("/", response_model={{ model.name }}Read, status_code=status.HTTP_201_CREATED)
async def create_{{ model.snake_name }}(payload: {{ model.name }}Create, db: AsyncSession = Depends(get_db)):
    obj = {{ model.name }}(**payload.model_dump())
    db.add(obj)
    await db.commit()
    await db.refresh(obj)
    return obj


@router.get("/", response_model=List[{{ model.name }}Read])
async def list_{{ model.snake_name }}s(db: AsyncSession = Depends(get_db)):
    result = await db.execute(select({{ model.name }}))
    return result.scalars().all()


@router.get("/{id}", response_model={{ model.name }}Read)
async def get_{{ model.snake_name }}(id: {{ model.pk_type }}, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select({{ model.name }}).where({{ model.name }}.id == id))
    obj = result.scalar_one_or_none()
    if not obj:
        raise HTTPException(status_code=404, detail="{{ model.name }} not found")
    return obj


@router.put("/{id}", response_model={{ model.name }}Read)
async def update_{{ model.snake_name }}(id: {{ model.pk_type }}, payload: {{ model.name }}Update, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select({{ model.name }}).where({{ model.name }}.id == id))
    obj = result.scalar_one_or_none()
    if not obj:
        raise HTTPException(status_code=404, detail="{{ model.name }} not found")

    for field, value in payload.model_dump(exclude_unset=True).items():
        setattr(obj, field, value)

    await db.commit()
    await db.refresh(obj)
    return obj


@router.delete("/{id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_{{ model.snake_name }}(id: {{ model.pk_type }}, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select({{ model.name }}).where({{ model.name }}.id == id))
    obj = result.scalar_one_or_none()
    if not obj:
        raise HTTPException(status_code=404, detail="{{ model.name }} not found")

    await db.delete(obj)
    await db.commit()
    return None
